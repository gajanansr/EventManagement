<div class="view-events-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <div class="title-section">
                <mat-icon class="header-icon">event</mat-icon>
                <div>
                    <h1 class="page-title">Events</h1>
                    <p class="page-subtitle">Browse and manage all events</p>
                </div>
            </div>
            <button *ngIf="roleName === 'PLANNER'" mat-raised-button color="primary" (click)="viewAllBookings()">
                <mat-icon>calendar_month</mat-icon>
                View Bookings
            </button>
        </div>
    </div>

    <!-- Alert Message -->
    <div *ngIf="message" class="alert-message" [@fadeInOut]
        [ngClass]="{'alert-success': message.type === 'success', 'alert-error': message.type === 'error'}">
        <mat-icon>{{ message.type === 'success' ? 'check_circle' : 'error' }}</mat-icon>
        <span>{{ message.text }}</span>
    </div>

    <!-- Search and Filters Bar -->
    <mat-card class="filters-card">
        <div class="filters-container">
            <!-- Search Bar -->
            <mat-form-field appearance="outline" class="search-field">
                <mat-label>Search events</mat-label>
                <input matInput [formControl]="searchControl" placeholder="Search by ID or title...">
                <mat-icon matPrefix>search</mat-icon>
                <button *ngIf="searchControl.value" matSuffix mat-icon-button (click)="clearSearch()">
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>

            <!-- Filter Chips -->
            <div class="filter-chips">
                <mat-chip-list>
                    <mat-chip [class.active]="selectedFilter === 'all'" (click)="selectedFilter = 'all'; getEvents()">All Events</mat-chip>
                    <mat-chip [class.active]="selectedFilter === 'past'" (click)="selectedFilter = 'past'; filterPastEvents()">Past</mat-chip>
                    <mat-chip [class.active]="selectedFilter === 'today'" (click)="selectedFilter = 'today'; filterTodayEvents()">Today</mat-chip>
                    <mat-chip [class.active]="selectedFilter === 'future'" (click)="selectedFilter = 'future'; filterFutureEvents()">Upcoming</mat-chip>
                </mat-chip-list>
            </div>

            <!-- Sort Dropdown -->
            <mat-form-field appearance="outline" class="sort-field">
                <mat-label>Sort by</mat-label>
                <mat-select [(value)]="selectedSort" (selectionChange)="onSortChange($event)">
                    <mat-option value="id">Event ID</mat-option>
                    <mat-option value="title">Title</mat-option>
                    <mat-option value="date">Date</mat-option>
                    <mat-option value="location">Location</mat-option>
                </mat-select>
                <mat-icon matPrefix>sort</mat-icon>
            </mat-form-field>
        </div>
    </mat-card>

    <!-- Events Grid -->
    <div class="events-grid">
        <mat-card *ngFor="let event of paginatedEvents" class="event-card" [@cardAnimation]>
            <!-- Event Image Header -->
            <div class="event-image-header">
                <img [src]="getEventImage(event)" [alt]="event.title" class="event-image">
                <div class="image-overlay">
                    <div class="event-badges">
                        <span class="event-id-badge">#{{ event.eventID }}</span>
                        <span class="status-badge" 
                            [ngClass]="{
                                'status-scheduled': event.status === 'Scheduled',
                                'status-cancelled': event.status === 'Cancelled',
                                'status-completed': event.status === 'Completed'
                            }">
                            {{ event.status }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Event Content -->
            <mat-card-content class="event-content">
                <h3 class="event-title">{{ event.title }}</h3>
                <p class="event-description">{{ event.description }}</p>

                <!-- Event Info Grid -->
                <div class="event-info-grid">
                    <div class="info-item">
                        <mat-icon class="info-icon">event</mat-icon>
                        <div class="info-details">
                            <span class="info-label">Date & Time</span>
                            <span class="info-value">{{ event.dateTime | date:'MMM d, y, h:mm a' }}</span>
                        </div>
                    </div>

                    <div class="info-item">
                        <mat-icon class="info-icon">location_on</mat-icon>
                        <div class="info-details">
                            <span class="info-label">Location</span>
                            <span class="info-value">{{ event.location }}</span>
                        </div>
                    </div>

                    <div class="info-item" *ngIf="event.allocations && event.allocations.length > 0">
                        <mat-icon class="info-icon">inventory_2</mat-icon>
                        <div class="info-details">
                            <span class="info-label">Resources</span>
                            <div class="resources-chips">
                                <mat-chip *ngFor="let allocation of event.allocations.slice(0, 3)">
                                    {{ allocation.resource?.name || 'N/A' }} ({{ allocation.quantity }})
                                </mat-chip>
                                <mat-chip *ngIf="event.allocations.length > 3" class="more-chip">
                                    +{{ event.allocations.length - 3 }} more
                                </mat-chip>
                            </div>
                        </div>
                    </div>

                    <div class="info-item" *ngIf="!event.allocations || event.allocations.length === 0">
                        <mat-icon class="info-icon">inventory_2</mat-icon>
                        <div class="info-details">
                            <span class="info-label">Resources</span>
                            <span class="info-value text-muted">No resources allocated</span>
                        </div>
                    </div>

                    <div class="info-item" *ngIf="roleName === 'PLANNER'">
                        <mat-icon class="info-icon">person</mat-icon>
                        <div class="info-details">
                            <span class="info-label">Assigned Staff</span>
                            <mat-chip *ngIf="event.assignedStaff" class="staff-chip">
                                {{ event.assignedStaff.fullName || event.assignedStaff.username }}
                            </mat-chip>
                            <button *ngIf="!event.assignedStaff" mat-stroked-button color="primary" 
                                    class="assign-staff-btn" (click)="openStaffAssignment(event)">
                                Assign Staff
                            </button>
                        </div>
                    </div>
                </div>
            </mat-card-content>

            <!-- Event Actions -->
            <mat-card-actions class="event-actions">
                <!-- PLANNER Actions -->
                <div *ngIf="roleName === 'PLANNER'" class="action-buttons">
                    <button mat-raised-button color="primary" (click)="openUpdateModal(event)">
                        <mat-icon>edit</mat-icon>
                        Update
                    </button>
                    <button mat-stroked-button (click)="openMessaging(event)">
                        <mat-icon>chat</mat-icon>
                        Messages
                    </button>
                </div>

                <!-- CLIENT Actions -->
                <div *ngIf="roleName === 'CLIENT'" class="action-buttons">
                    <button mat-raised-button color="accent" (click)="openBookingForm(event)">
                        <mat-icon>check_circle</mat-icon>
                        Book Event
                    </button>
                    <button mat-stroked-button (click)="openMessaging(event)">
                        <mat-icon>chat</mat-icon>
                        Messages
                    </button>
                </div>

                <!-- STAFF Actions -->
                <div *ngIf="roleName === 'STAFF'" class="action-buttons">
                    <button mat-stroked-button (click)="openMessaging(event)">
                        <mat-icon>chat</mat-icon>
                        Messages
                    </button>
                </div>
            </mat-card-actions>
        </mat-card>
    </div>

    <!-- Empty State -->
    <div *ngIf="paginatedEvents.length === 0" class="empty-state" [@fadeInOut]>
        <div class="empty-icon">
            <mat-icon>event_busy</mat-icon>
        </div>
        <h3>No Events Found</h3>
        <p>There are no events matching your criteria.</p>
    </div>

    <!-- Pagination -->
    <div *ngIf="paginatedEvents.length > 0" class="pagination-controls">
        <button mat-button (click)="previousPage()" [disabled]="currentPage === 1">
            <mat-icon>chevron_left</mat-icon>
            Previous
        </button>
        <div class="page-info">
            <span class="current-page">{{ currentPage }}</span>
            <span class="separator">/</span>
            <span class="total-pages">{{ totalPages }}</span>
        </div>
        <button mat-button (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next
            <mat-icon>chevron_right</mat-icon>
        </button>
    </div>
</div>

<!-- Update Modal -->
<div class="custom-modal-overlay" *ngIf="showUpdateModal" (click)="closeUpdateModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>{{ isUpdate ? 'Update Event' : 'Create Event' }}</h5>
                <button type="button" class="btn-close" (click)="closeUpdateModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
                    
                    <div class="form-group mb-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" id="title" formControlName="title" class="form-control" />
                        <div *ngIf="itemForm.get('title')?.hasError('required') && itemForm.get('title')?.touched"
                            class="text-danger small mt-1">
                            Title is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description:</label>
                        <textarea id="description" formControlName="description" class="form-control" rows="3"></textarea>
                        <div *ngIf="itemForm.get('description')?.hasError('required') && itemForm.get('description')?.touched"
                            class="text-danger small mt-1">
                            Description is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="dateTime" class="form-label">Date Time:</label>
                        <input type="datetime-local" id="dateTime" formControlName="dateTime" class="form-control" />
                        <div *ngIf="itemForm.get('dateTime')?.hasError('required') && itemForm.get('dateTime')?.touched"
                            class="text-danger small mt-1">
                            Date and Time are required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="location" class="form-label">Location:</label>
                        <input type="text" id="location" formControlName="location" class="form-control" />
                        <div *ngIf="itemForm.get('location')?.hasError('required') && itemForm.get('location')?.touched"
                            class="text-danger small mt-1">
                            Location is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="status" class="form-label">Status:</label>
                        <select id="status" class="form-select" formControlName="status">
                            <option value="" disabled selected>Select status</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <div *ngIf="itemForm.get('status')?.hasError('required') && itemForm.get('status')?.touched"
                            class="text-danger small mt-1">
                            Status is required.
                        </div>
                    </div>
                </form>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeUpdateModal()">Close</button>
                <button type="button" class="btn btn-primary" (click)="onSubmit()">
                    {{ isUpdate ? 'Update Event' : 'Create Event' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Staff Assignment Modal -->
<div class="custom-modal-overlay" *ngIf="showStaffAssignModal" (click)="closeStaffAssignModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Assign Staff to Event</h5>
                <button type="button" class="btn-close" (click)="closeStaffAssignModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForStaff">
                    <h6>Event: {{ selectedEventForStaff.title }}</h6>
                    <p class="text-muted small">{{ selectedEventForStaff.location }} - {{ selectedEventForStaff.dateTime | date:'medium' }}</p>
                    
                    <div class="form-group mb-3">
                        <label for="staffSelect" class="form-label">Select Staff Member:</label>
                        <select id="staffSelect" class="form-select" [(ngModel)]="selectedStaffId">
                            <option value="" disabled selected>Choose staff...</option>
                            <option *ngFor="let staff of staffList" [value]="staff.userId">
                                {{ staff.fullName || staff.username }} ({{ staff.email }})
                            </option>
                        </select>
                    </div>
                    
                    <div *ngIf="staffAssignMessage" class="alert" 
                         [ngClass]="{'alert-success': staffAssignSuccess, 'alert-danger': !staffAssignSuccess}">
                        {{ staffAssignMessage }}
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeStaffAssignModal()">Close</button>
                <button type="button" class="btn btn-primary" (click)="assignStaff()" [disabled]="!selectedStaffId">
                    Assign Staff
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Messaging Modal -->
<div class="custom-modal-overlay" *ngIf="showMessagingModal" (click)="closeMessagingModal()">
    <div class="custom-modal-dialog custom-modal-lg" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Event Messages</h5>
                <button type="button" class="btn-close" (click)="closeMessagingModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForMessaging">
                    <h6>Event: {{ selectedEventForMessaging.title }}</h6>
                    <hr>
                    
                    <!-- Messages Display -->
                    <div class="messages-container" style="max-height: 400px; overflow-y: auto;">
                        <div *ngIf="messages.length === 0" class="text-center text-muted py-4">
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                        <div *ngFor="let msg of messages" class="message mb-3">
                            <div class="d-flex" [ngClass]="{'justify-content-end': msg.senderRole === roleName}">
                                <div class="message-bubble p-3 rounded" 
                                     [ngClass]="{'bg-primary text-white': msg.senderRole === roleName, 'bg-light': msg.senderRole !== roleName}"
                                     style="max-width: 70%;">
                                    <strong>{{ msg.sender.fullName || msg.sender.username }}</strong>
                                    <small class="d-block text-muted" [ngClass]="{'text-white-50': msg.senderRole === roleName}">
                                        {{ msg.senderRole }}
                                    </small>
                                    <p class="mb-1 mt-2">{{ msg.content }}</p>
                                    <small class="text-muted" [ngClass]="{'text-white-50': msg.senderRole === roleName}">
                                        {{ msg.sentAt | date:'short' }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" [(ngModel)]="newMessage" 
                                   placeholder="Type your message..." (keyup.enter)="sendMessage()">
                            <button class="btn btn-primary" (click)="sendMessage()" [disabled]="!newMessage">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal (for CLIENT) -->
<div class="custom-modal-overlay" *ngIf="showBookingModal" (click)="closeBookingModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Book Event</h5>
                <button type="button" class="btn-close" (click)="closeBookingModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForBooking">
                    <h6>{{ selectedEventForBooking.title }}</h6>
                    <p class="text-muted small">
                        <i class="bi bi-calendar"></i> {{ selectedEventForBooking.dateTime | date:'medium' }}<br>
                        <i class="bi bi-geo-alt"></i> {{ selectedEventForBooking.location }}
                    </p>
                    <p class="mb-3">{{ selectedEventForBooking.description }}</p>
                    
                    <div class="mb-3">
                        <label for="clientRequirements" class="form-label">Your Requirements:</label>
                        <textarea id="clientRequirements" class="form-control" rows="4" 
                                  [(ngModel)]="bookingRequirements" 
                                  placeholder="Please describe your specific requirements or preferences for this event..."></textarea>
                        <small class="text-muted">Optional: Add any special requests or requirements</small>
                    </div>
                    
                    <div *ngIf="bookingMessage" class="alert" 
                         [ngClass]="{'alert-success': bookingSuccess, 'alert-danger': !bookingSuccess}">
                        {{ bookingMessage }}
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeBookingModal()">Cancel</button>
                <button type="button" class="btn btn-success" (click)="submitBooking()">
                    Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bookings List Modal (for PLANNER) -->
<div *ngIf="showBookingsListModal" class="custom-modal-overlay" (click)="closeBookingsListModal()">
    <div class="custom-modal-content" (click)="$event.stopPropagation()" style="max-width: 900px;">
        <div class="custom-modal-header">
            <h5>All Booking Requests</h5>
            <button type="button" class="btn-close" (click)="closeBookingsListModal()"></button>
        </div>
        <div class="custom-modal-body">
            <div *ngIf="allBookings.length === 0" class="text-center py-4">
                <p class="text-muted">No bookings found.</p>
            </div>
            <div *ngIf="allBookings.length > 0" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Event Title</th>
                            <th>Client</th>
                            <th>Booking Date</th>
                            <th>Status</th>
                            <th>Requirements</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let booking of allBookings">
                            <td>{{ booking.bookingId }}</td>
                            <td>{{ booking.event?.title || 'N/A' }}</td>
                            <td>{{ booking.user?.username || 'N/A' }}</td>
                            <td>{{ booking.bookingDate | date:'short' }}</td>
                            <td>
                                <span [ngClass]="getBookingStatusClass(booking.status)">
                                    {{ booking.status }}
                                </span>
                            </td>
                            <td>
                                <small>{{ booking.clientRequirements || 'None' }}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" (click)="openBookingStatusUpdate(booking)">
                                    Update Status
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeBookingsListModal()">Close</button>
        </div>
    </div>
</div>

<!-- Booking Status Update Modal (for PLANNER) -->
<div *ngIf="showBookingStatusModal" class="custom-modal-overlay" (click)="closeBookingStatusModal()">
    <div class="custom-modal-content" (click)="$event.stopPropagation()">
        <div class="custom-modal-header">
            <h5>Update Booking Status</h5>
            <button type="button" class="btn-close" (click)="closeBookingStatusModal()"></button>
        </div>
        <div class="custom-modal-body">
            <div *ngIf="selectedBooking">
                <div class="mb-3">
                    <strong>Booking ID:</strong> {{ selectedBooking.bookingId }}<br>
                    <strong>Event:</strong> {{ selectedBooking.event?.title }}<br>
                    <strong>Client:</strong> {{ selectedBooking.user?.username }}<br>
                    <strong>Requirements:</strong> {{ selectedBooking.clientRequirements || 'None' }}
                </div>
                
                <div class="mb-3">
                    <label for="bookingStatus" class="form-label">Status</label>
                    <select id="bookingStatus" [(ngModel)]="bookingStatusUpdate" class="form-select">
                        <option value="PENDING">Pending</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="APPROVED">Approved</option>
                        <option value="REJECTED">Rejected</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="bookingNotes" class="form-label">Notes (Optional)</label>
                    <textarea id="bookingNotes" [(ngModel)]="bookingNotes" 
                              class="form-control" rows="3"
                              placeholder="Add any notes for the client..."></textarea>
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeBookingStatusModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="updateBookingStatus()">
                Update Status
            </button>
        </div>
    </div>
</div>
