<div class="profile-container">
    <!-- Alert Messages -->
    <div *ngIf="showSuccess || showError" class="alert-message" [@fadeInOut]
        [ngClass]="{'alert-success': showSuccess, 'alert-error': showError}">
        <mat-icon>{{ showSuccess ? 'check_circle' : 'error' }}</mat-icon>
        <span>{{ showSuccess ? successMessage : errorMessage }}</span>
        <button mat-icon-button (click)="showSuccess = false; showError = false">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Profile Header Card -->
    <mat-card class="profile-header-card">
        <div class="profile-header">
            <div class="avatar-section">
                <div class="avatar-wrapper">
                    <img [src]="getAvatarUrl()" [alt]="profile?.username || 'User'" class="avatar-image">
                    <button mat-mini-fab color="primary" class="avatar-edit-btn" (click)="fileInput.click()">
                        <mat-icon>photo_camera</mat-icon>
                    </button>
                    <input #fileInput type="file" accept="image/*" (change)="onAvatarChange($event)" style="display: none;">
                </div>
                <div class="header-info">
                    <h1 class="profile-name">{{ profile?.fullName || profile?.username || 'User' }}</h1>
                    <p class="profile-email">{{ profile?.email || 'No email provided' }}</p>
                    <mat-chip class="role-chip">
                        <mat-icon>{{ getRoleIcon() }}</mat-icon>
                        {{ profile?.role || 'USER' }}
                    </mat-chip>
                </div>
            </div>
            <div class="header-actions">
                <button mat-raised-button color="primary" (click)="toggleEditMode()" *ngIf="!isEditMode">
                    <mat-icon>edit</mat-icon>
                    Edit Profile
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stat-item">
                <div class="stat-icon">
                    <mat-icon>event</mat-icon>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ getUserStats().events }}</span>
                    <span class="stat-label">Events</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <mat-icon>bookmark</mat-icon>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ getUserStats().bookings }}</span>
                    <span class="stat-label">Bookings</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <mat-icon>schedule</mat-icon>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ getUserStats().days }}</span>
                    <span class="stat-label">Days Active</span>
                </div>
            </div>
        </div>
    </mat-card>

    <!-- Tabs Content -->
    <mat-card class="tabs-card">
        <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="300ms">
            <!-- Profile Info Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>person</mat-icon>
                    Profile Info
                </ng-template>
                <div class="tab-content">
                    <form [formGroup]="profileForm" (ngSubmit)="onSubmitProfile()" *ngIf="profile">
                        <div class="form-grid">
                            <mat-form-field appearance="outline">
                                <mat-label>Username</mat-label>
                                <input matInput [value]="profile.username" disabled>
                                <mat-icon matPrefix>account_circle</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Role</mat-label>
                                <input matInput [value]="profile.role" disabled>
                                <mat-icon matPrefix>badge</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Full Name</mat-label>
                                <input matInput formControlName="fullName" [readonly]="!isEditMode">
                                <mat-icon matPrefix>person</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Email</mat-label>
                                <input matInput type="email" formControlName="email" [readonly]="!isEditMode">
                                <mat-icon matPrefix>email</mat-icon>
                                <mat-error *ngIf="profileForm.get('email')?.hasError('email')">
                                    Please enter a valid email
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Phone Number</mat-label>
                                <input matInput type="tel" formControlName="phoneNumber" [readonly]="!isEditMode">
                                <mat-icon matPrefix>phone</mat-icon>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Address</mat-label>
                                <input matInput formControlName="address" [readonly]="!isEditMode">
                                <mat-icon matPrefix>location_on</mat-icon>
                            </mat-form-field>
                        </div>

                        <div class="form-actions" *ngIf="isEditMode">
                            <button mat-raised-button color="primary" type="submit" [disabled]="!profileForm.valid">
                                <mat-icon>save</mat-icon>
                                Save Changes
                            </button>
                            <button mat-stroked-button type="button" (click)="toggleEditMode()">
                                <mat-icon>close</mat-icon>
                                Cancel
                            </button>
                        </div>
                    </form>

                    <div *ngIf="!profile" class="loading-state">
                        <mat-spinner></mat-spinner>
                        <p>Loading profile...</p>
                    </div>
                </div>
            </mat-tab>

            <!-- Settings Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>settings</mat-icon>
                    Settings
                </ng-template>
                <div class="tab-content">
                    <h3 class="section-title">Change Password</h3>
                    <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()">
                        <div class="form-grid">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Current Password</mat-label>
                                <input matInput [type]="hideCurrentPassword ? 'password' : 'text'" 
                                       formControlName="currentPassword">
                                <mat-icon matPrefix>lock</mat-icon>
                                <button mat-icon-button matSuffix (click)="hideCurrentPassword = !hideCurrentPassword" 
                                        type="button">
                                    <mat-icon>{{ hideCurrentPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
                                </button>
                                <mat-error *ngIf="passwordForm.get('currentPassword')?.hasError('required')">
                                    Current password is required
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>New Password</mat-label>
                                <input matInput [type]="hideNewPassword ? 'password' : 'text'" 
                                       formControlName="newPassword">
                                <mat-icon matPrefix>lock_open</mat-icon>
                                <button mat-icon-button matSuffix (click)="hideNewPassword = !hideNewPassword" 
                                        type="button">
                                    <mat-icon>{{ hideNewPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
                                </button>
                                <mat-hint>At least 6 characters</mat-hint>
                                <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('minlength')">
                                    Password must be at least 6 characters
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Confirm New Password</mat-label>
                                <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" 
                                       formControlName="confirmPassword">
                                <mat-icon matPrefix>lock_reset</mat-icon>
                                <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" 
                                        type="button">
                                    <mat-icon>{{ hideConfirmPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
                                </button>
                                <mat-error *ngIf="passwordForm.hasError('mismatch')">
                                    Passwords do not match
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <div class="form-actions">
                            <button mat-raised-button color="primary" type="submit" [disabled]="!passwordForm.valid">
                                <mat-icon>vpn_key</mat-icon>
                                Update Password
                            </button>
                            <button mat-stroked-button type="button" (click)="passwordForm.reset()">
                                <mat-icon>refresh</mat-icon>
                                Reset
                            </button>
                        </div>
                    </form>
                </div>
            </mat-tab>

            <!-- Activity History Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon>history</mat-icon>
                    Activity
                </ng-template>
                <div class="tab-content">
                    <h3 class="section-title">Recent Activity</h3>
                    <div class="activity-timeline">
                        <div class="activity-item" *ngFor="let activity of getRecentActivities()">
                            <div class="activity-icon" [ngClass]="'activity-' + activity.type">
                                <mat-icon>{{ activity.icon }}</mat-icon>
                            </div>
                            <div class="activity-content">
                                <h4 class="activity-title">{{ activity.title }}</h4>
                                <p class="activity-description">{{ activity.description }}</p>
                                <span class="activity-time">{{ activity.time }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Notifications Tab -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon [matBadge]="getUnreadCount()" matBadgeColor="warn" 
                              [matBadgeHidden]="getUnreadCount() === 0">notifications</mat-icon>
                    Notifications
                </ng-template>
                <div class="tab-content">
                    <h3 class="section-title">Notification Preferences</h3>
                    <div class="notification-settings">
                        <mat-slide-toggle [checked]="notificationSettings.emailNotifications" 
                                         (change)="toggleNotification('emailNotifications')">
                            <div class="toggle-content">
                                <mat-icon>email</mat-icon>
                                <div>
                                    <strong>Email Notifications</strong>
                                    <p>Receive notifications via email</p>
                                </div>
                            </div>
                        </mat-slide-toggle>

                        <mat-slide-toggle [checked]="notificationSettings.eventReminders" 
                                         (change)="toggleNotification('eventReminders')">
                            <div class="toggle-content">
                                <mat-icon>event_note</mat-icon>
                                <div>
                                    <strong>Event Reminders</strong>
                                    <p>Get reminders before events</p>
                                </div>
                            </div>
                        </mat-slide-toggle>

                        <mat-slide-toggle [checked]="notificationSettings.bookingUpdates" 
                                         (change)="toggleNotification('bookingUpdates')">
                            <div class="toggle-content">
                                <mat-icon>bookmark</mat-icon>
                                <div>
                                    <strong>Booking Updates</strong>
                                    <p>Updates about your bookings</p>
                                </div>
                            </div>
                        </mat-slide-toggle>

                        <mat-slide-toggle [checked]="notificationSettings.systemAlerts" 
                                         (change)="toggleNotification('systemAlerts')">
                            <div class="toggle-content">
                                <mat-icon>warning</mat-icon>
                                <div>
                                    <strong>System Alerts</strong>
                                    <p>Important system notifications</p>
                                </div>
                            </div>
                        </mat-slide-toggle>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card>
</div>
