<div class="container py-4">
    <h1 class="text-center mb-4 text-primary">My Profile</h1>

    <!-- Alert Messages -->
    <div class="alert-container" *ngIf="showSuccess || showError">
        <div class="alert" [ngClass]="{'alert-success': showSuccess, 'alert-danger': showError}">
            {{ showSuccess ? successMessage : errorMessage }}
            <button type="button" class="btn-close" (click)="showSuccess = false; showError = false" aria-label="Close"></button>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Profile Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Profile Information</h4>
                    <button class="btn btn-light btn-sm" (click)="toggleEditMode()" *ngIf="!isEditMode">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <form [formGroup]="profileForm" (ngSubmit)="onSubmitProfile()" *ngIf="profile">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Username</label>
                                <p class="form-control-plaintext" *ngIf="!isEditMode">{{ profile.username }}</p>
                                <input type="text" class="form-control" [value]="profile.username" disabled *ngIf="isEditMode">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Role</label>
                                <p class="form-control-plaintext">
                                    <span class="badge bg-info">{{ profile.role }}</span>
                                </p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label fw-bold">Full Name</label>
                                <p class="form-control-plaintext" *ngIf="!isEditMode">
                                    {{ profile.fullName || 'Not provided' }}
                                </p>
                                <input type="text" id="fullName" formControlName="fullName" 
                                       class="form-control" *ngIf="isEditMode">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label fw-bold">Email</label>
                                <p class="form-control-plaintext" *ngIf="!isEditMode">
                                    {{ profile.email || 'Not provided' }}
                                </p>
                                <input type="email" id="email" formControlName="email" 
                                       class="form-control" *ngIf="isEditMode">
                                <div *ngIf="isEditMode && profileForm.get('email')?.invalid && profileForm.get('email')?.touched" 
                                     class="text-danger small mt-1">
                                    Please enter a valid email
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label fw-bold">Phone Number</label>
                                <p class="form-control-plaintext" *ngIf="!isEditMode">
                                    {{ profile.phoneNumber || 'Not provided' }}
                                </p>
                                <input type="tel" id="phoneNumber" formControlName="phoneNumber" 
                                       class="form-control" *ngIf="isEditMode">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="address" class="form-label fw-bold">Address</label>
                                <p class="form-control-plaintext" *ngIf="!isEditMode">
                                    {{ profile.address || 'Not provided' }}
                                </p>
                                <input type="text" id="address" formControlName="address" 
                                       class="form-control" *ngIf="isEditMode">
                            </div>
                        </div>

                        <div class="d-flex gap-2" *ngIf="isEditMode">
                            <button type="submit" class="btn btn-primary" [disabled]="!profileForm.valid">
                                Save Changes
                            </button>
                            <button type="button" class="btn btn-secondary" (click)="toggleEditMode()">
                                Cancel
                            </button>
                        </div>
                    </form>

                    <div *ngIf="!profile" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change Password Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Security</h4>
                    <button class="btn btn-light btn-sm" (click)="togglePasswordChange()" *ngIf="!isChangingPassword">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                </div>
                <div class="card-body">
                    <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()" *ngIf="isChangingPassword">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <div class="password-input-wrapper">
                                <input [type]="showCurrentPassword ? 'text' : 'password'" 
                                       id="currentPassword" formControlName="currentPassword" 
                                       class="form-control" placeholder="Enter current password">
                                <button type="button" class="password-toggle-btn" (click)="toggleCurrentPasswordVisibility()">
                                    <i class="bi" [ngClass]="showCurrentPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                            <div *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched" 
                                 class="text-danger small mt-1">
                                Current password is required
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">New Password</label>
                            <div class="password-input-wrapper">
                                <input [type]="showNewPassword ? 'text' : 'password'" 
                                       id="password" formControlName="password" 
                                       class="form-control" placeholder="Enter new password" [ngClass]="{
                                        'is-invalid': passwordForm.get('password')?.invalid && passwordForm.get('password')?.touched,
                                        'is-valid': passwordForm.get('password')?.valid && passwordForm.get('password')?.touched
                                }">
                                <button type="button" class="password-toggle-btn" (click)="toggleNewPasswordVisibility()">
                                    <i class="bi" [ngClass]="showNewPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                            <div class="password-requirements" *ngIf="showPasswordRequirements && passwordForm.get('password')?.dirty">
                                <ul>
                                  <li *ngFor="let rule of passwordRules" [class.satisfied]="rule.satisfied" [hidden]="rule.satisfied">
                                    <small>{{ rule.label }}</small>
                                  </li>
                                </ul>
                            </div>
                        </div>


                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <div class="password-input-wrapper">
                                <input [type]="showConfirmPassword ? 'text' : 'password'" 
                                       id="confirmPassword" formControlName="confirmPassword" 
                                       class="form-control" placeholder="Confirm new password">
                                <button type="button" class="password-toggle-btn" (click)="toggleConfirmPasswordVisibility()">
                                    <i class="bi" [ngClass]="showConfirmPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                                </button>
                            </div>
                            <div *ngIf="passwordForm.hasError('mismatch') && passwordForm.get('confirmPassword')?.touched" 
                                 class="text-danger small mt-1">
                                Passwords do not match
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" [disabled]="!passwordForm.valid">
                                Change Password
                            </button>
                            <button type="button" class="btn btn-secondary" (click)="togglePasswordChange()">
                                Cancel
                            </button>
                        </div>
                    </form>

                    <div *ngIf="!isChangingPassword" class="text-muted">
                        <p class="mb-0"><i class="bi bi-shield-check"></i> Your password is secure</p>
                        <small>Click "Change Password" to update your password</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
